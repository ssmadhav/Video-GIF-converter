<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video to GIF Converter (Max 2.5MB)</title>
    <style>
        :root {
            --primary: #4a6fa5;
            --secondary: #166088;
            --accent: #4fc3f7;
            --light: #f8f9fa;
            --dark: #212529;
            --danger: #dc3545;
            --success: #28a745;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1 {
            color: var(--secondary);
            text-align: center;
            margin-bottom: 30px;
            font-weight: 600;
        }
        
        .upload-container {
            border: 2px dashed var(--primary);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
            position: relative;
        }
        
        .upload-container:hover {
            border-color: var(--accent);
            background-color: rgba(79, 195, 247, 0.05);
        }
        
        .upload-icon img {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            opacity: 0.7;
        }
        
        .upload-text h3 {
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .upload-text p {
            color: var(--dark);
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-accent {
            background-color: var(--accent);
        }
        
        .btn-accent:hover {
            background-color: #3aa8d8;
        }
        
        #fileInput {
            display: none;
        }
        
        .preview-container {
            display: none;
            margin-bottom: 30px;
        }
        
        .video-preview, .gif-preview {
            width: 100%;
            margin-bottom: 20px;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .video-preview video, .gif-preview img {
            width: 100%;
            display: block;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        label {
            font-weight: 500;
            color: var(--dark);
        }
        
        input[type="range"], input[type="number"] {
            flex: 1;
            min-width: 200px;
        }
        
        .progress-container {
            display: none;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--accent);
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            text-align: center;
            font-size: 14px;
            color: var(--dark);
        }
        
        .result-container {
            display: none;
            text-align: center;
        }
        
        .file-info {
            background-color: #f1f1f1;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
        }
        
        .file-info p {
            margin-bottom: 5px;
        }
        
        .error {
            color: var(--danger);
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            .upload-container {
                padding: 20px 15px;
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Video to GIF Converter</h1>
        <p class="error" id="errorMessage"></p>
        
        <div class="upload-container" id="dropZone">
            <div class="upload-icon">
                <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/5c6ccbf2-f535-409d-8e8a-bcd414d87e05.png" alt="Video upload icon with a camera and arrow pointing up" />
            </div>
            <div class="upload-text">
                <h3>Upload Your Video</h3>
                <p>Drag & drop your video file here or click to browse (MP4, WebM, OGG supported)</p>
                <input type="file" id="fileInput" accept="video/*">
                <button class="btn" id="uploadBtn">Choose File</button>
            </div>
        </div>
        
        <div class="preview-container" id="previewContainer">
            <h3>Input Video Preview</h3>
            <div class="video-preview">
                <video id="videoPreview" controls></video>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="quality">Quality:</label>
                <input type="range" id="quality" min="1" max="10" value="7">
                <span id="qualityValue">7</span>
            </div>
            
            <div class="control-group">
                <label for="fps">Frames per second:</label>
                <input type="range" id="fps" min="5" max="30" value="12">
                <span id="fpsValue">12</span>
            </div>
            
            <div class="control-group">
                <label for="width">Width (px):</label>
                <input type="number" id="width" min="100" max="1920" value="640">
            </div>
            
            <button class="btn btn-accent" id="convertBtn" disabled>Convert to GIF</button>
        </div>
        
        <div class="progress-container" id="progressContainer">
            <h3>Conversion Progress</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p class="progress-text" id="progressText">Initializing...</p>
        </div>
        
        <div class="result-container" id="resultContainer">
            <h3>Your GIF is Ready!</h3>
            <div class="file-info">
                <p><strong>File Size:</strong> <span id="fileSize">0</span> MB</p>
                <p><strong>Resolution:</strong> <span id="resolution">0x0</span> px</p>
                <p><strong>Duration:</strong> <span id="duration">0</span> seconds</p>
            </div>
            <div class="gif-preview">
                <img id="gifPreview" src="" alt="Preview of the converted GIF will appear here" src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/7bf213f7-8039-404a-91e2-bc5e457c4649.png">
            </div>
            <button class="btn btn-accent" id="downloadBtn">Download GIF</button>
        </div>
    </div>

    <!-- Load FFmpeg -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>
    
    <script>
        // Initialize elements
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const dropZone = document.getElementById('dropZone');
        const videoPreview = document.getElementById('videoPreview');
        const previewContainer = document.getElementById('previewContainer');
        const convertBtn = document.getElementById('convertBtn');
        const qualitySlider = document.getElementById('quality');
        const qualityValue = document.getElementById('qualityValue');
        const fpsSlider = document.getElementById('fps');
        const fpsValue = document.getElementById('fpsValue');
        const widthInput = document.getElementById('width');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const resultContainer = document.getElementById('resultContainer');
        const gifPreview = document.getElementById('gifPreview');
        const fileSizeSpan = document.getElementById('fileSize');
        const resolutionSpan = document.getElementById('resolution');
        const durationSpan = document.getElementById('duration');
        const downloadBtn = document.getElementById('downloadBtn');
        const errorMessage = document.getElementById('errorMessage');
        
        // State variables
        let videoFile = null;
        let videoDuration = 0;
        let videoWidth = 0;
        let videoHeight = 0;
        let ffmpeg = null;
        
        // Update slider value displays
        qualitySlider.addEventListener('input', () => {
            qualityValue.textContent = qualitySlider.value;
        });
        
        fpsSlider.addEventListener('input', () => {
            fpsValue.textContent = fpsSlider.value;
        });
        
        // File selection
        uploadBtn.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                handleFile(e.target.files[0]);
            }
        });
        
        // Drag and drop handling
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--accent)';
            dropZone.style.backgroundColor = 'rgba(79, 195, 247, 0.1)';
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.style.borderColor = 'var(--primary)';
            dropZone.style.backgroundColor = 'white';
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--primary)';
            dropZone.style.backgroundColor = 'white';
            
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        
        // Handle selected file
        function handleFile(file) {
            // Check file type
            if (!file.type.includes('video/')) {
                showError('Please upload a video file (MP4, WebM, or OGG)');
                return;
            }
            
            // Check file size (set limit to 100MB to prevent memory issues)
            if (file.size > 100 * 1024 * 1024) {
                showError('Video is too large. Maximum 100MB allowed.');
                return;
            }
            
            videoFile = file;
            
            // Create video preview
            videoPreview.src = URL.createObjectURL(file);
            previewContainer.style.display = 'block';
            
            // Get video metadata when loaded
            videoPreview.onloadedmetadata = () => {
                videoDuration = videoPreview.duration;
                videoWidth = videoPreview.videoWidth;
                videoHeight = videoPreview.videoHeight;
                
                // Set default width (maintaining aspect ratio)
                const targetWidth = Math.min(640, videoWidth);
                const targetHeight = Math.round(targetWidth * (videoHeight / videoWidth));
                widthInput.value = targetWidth;
                
                // Enable convert button
                convertBtn.disabled = false;
            };
            
            hideError();
        }
        
        // Initialize FFmpeg when convert button is clicked
        convertBtn.addEventListener('click', async () => {
            if (!videoFile) return;
            
            showProgress('Initializing FFmpeg...', 0);
            
            try {
                // Load FFmpeg
                if (!ffmpeg) {
                    ffmpeg = createFFmpeg({ log: true });
                    await ffmpeg.load();
                }
                
                // Prepare parameters
                const quality = parseInt(qualitySlider.value);
                const fps = parseInt(fpsSlider.value);
                const width = parseInt(widthInput.value);
                const height = Math.round(width * (videoHeight / videoWidth));
                
                // Calculate approximate duration to process (max 10 seconds)
                const duration = Math.min(10, videoDuration);
                
                showProgress('Processing video...', 10);
                
                // Write the file to FFmpeg filesystem
                ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(videoFile));
                
                // Run FFmpeg command
                await ffmpeg.run(
                    '-i', 'input.mp4',
                    '-t', duration.toString(),
                    '-vf', `fps=${fps},scale=${width}:${height}`,
                    '-f', 'gif',
                    'output.gif'
                );
                
                showProgress('Optimizing GIF size...', 80);
                
                // Read the result
                const data = ffmpeg.FS('readFile', 'output.gif');
                
                // Check if file is too large and apply additional compression
                let gifBlob = new Blob([data.buffer], { type: 'image/gif' });
                let gifSize = gifBlob.size / (1024 * 1024); // MB
                
                // Compression loop to ensure size ≤2.5MB
                let qualityAdjustment = quality;
                while (gifSize > 2.5 && qualityAdjustment > 1) {
                    qualityAdjustment -= 1;
                    
                    showProgress(`Compressing (attempt ${quality - qualityAdjustment + 1})...`, 80 + (5 * (quality - qualityAdjustment)));
                    
                    await ffmpeg.run(
                        '-i', 'input.mp4',
                        '-t', duration.toString(),
                        '-vf', `fps=${Math.max(5, fps - 2)},scale=${Math.max(100, width - 50)}:${Math.max(50, height - 50)}`,
                        '-f', 'gif',
                        'output.gif'
                    );
                    
                    const newData = ffmpeg.FS('readFile', 'output.gif');
                    gifBlob = new Blob([newData.buffer], { type: 'image/gif' });
                    gifSize = gifBlob.size / (1024 * 1024);
                }
                
                if (gifSize > 2.5) {
                    throw new Error('Unable to compress video to under 2.5MB while maintaining reasonable quality. Try a shorter video or lower settings.');
                }
                
                // Final output
                const gifUrl = URL.createObjectURL(gifBlob);
                
                // Display result
                showProgress('Done!', 100);
                
                // Update UI with result
                gifPreview.src = gifUrl;
                fileSizeSpan.textContent = gifSize.toFixed(2);
                resolutionSpan.textContent = `${width}x${height}`;
                durationSpan.textContent = duration.toFixed(1);
                
                // Show result container
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    resultContainer.style.display = 'block';
                }, 500);
                
                // Set up download
                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = gifUrl;
                    a.download = `${videoFile.name.split('.')[0]}.gif`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                };
                
            } catch (err) {
                showError(err.message || 'An error occurred during conversion.');
                console.error(err);
            }
        });
        
        // Helper function to show progress
        function showProgress(message, percent) {
            progressContainer.style.display = 'block';
            progressFill.style.width = `${percent}%`;
            progressText.textContent = message;
        }
        
        // Helper function for error handling
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        function hideError() {
            errorMessage.style.display = 'none';
        }
        
        // Helper function to read file as ArrayBuffer
        function fetchFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(new Uint8Array(e.target.result));
                reader.onerror = (e) => reject(e);
                reader.readAsArrayBuffer(file);
            });
        }
    </script>
</body>
</html>

