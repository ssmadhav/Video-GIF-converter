<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video to GIF Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ffmpeg.js/4.2.9003/ffmpeg.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .dropzone {
            border: 2px dashed #4a5568;
            transition: all 0.3s;
        }
        .dropzone.active {
            border-color: #3182ce;
            background-color: #ebf8ff;
        }
        #canvas {
            max-width: 100%;
            display: none;
        }
        #preview {
            max-width: 100%;
            max-height: 300px;
            display: block;
        }
        .progress-container {
            height: 6px;
            background-color: #e2e8f0;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #4299e1;
            transition: width 0.3s;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-8">Video to GIF Converter</h1>
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div 
                id="dropzone" 
                class="dropzone rounded-lg p-12 text-center cursor-pointer"
                ondragover="event.preventDefault(); document.getElementById('dropzone').classList.add('active')"
                ondragleave="document.getElementById('dropzone').classList.remove('active')"
                ondrop="event.preventDefault(); document.getElementById('dropzone').classList.remove('active'); handleDrop(event)"
            >
                <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/51f169f8-e2fa-434d-b8ad-f35e0f86e13b.png" alt="Plus sign icon" class="mx-auto mb-4"/>
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Drag & Drop Video File Here</h2>
                <p class="text-gray-500 mb-4">or</p>
                <input type="file" id="fileInput" accept="video/*" class="hidden" />
                <button 
                    onclick="document.getElementById('fileInput').click()" 
                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors"
                >
                    Select File
                </button>
            </div>
            <div id="videoInfo" class="mt-4 hidden">
                <h3 class="font-medium text-gray-700">Selected File: <span id="fileName" class="font-normal"></span></h3>
                <p class="text-gray-500 text-sm">Max output size: 2.5MB</p>
            </div>
        </div>

        <div id="controls" class="bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Conversion Settings</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="startTime" class="block text-sm font-medium text-gray-700 mb-1">Start Time (seconds)</label>
                    <input type="number" id="startTime" min="0" value="0" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label for="duration" class="block text-sm font-medium text-gray-700 mb-1">Duration (seconds)</label>
                    <input type="number" id="duration" min="1" value="5" max="15" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label for="fps" class="block text-sm font-medium text-gray-700 mb-1">Frames per second</label>
                    <select id="fps" class="w-full px-3 py-2 border rounded-lg">
                        <option value="15">15 FPS</option>
                        <option value="10" selected>10 FPS</option>
                        <option value="5">5 FPS</option>
                    </select>
                </div>
                <div>
                    <label for="quality" class="block text-sm font-medium text-gray-700 mb-1">Quality</label>
                    <select id="quality" class="w-full px-3 py-2 border rounded-lg">
                        <option value="high">High</option>
                        <option value="medium" selected>Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
            </div>

            <div class="mb-4">
                <h3 class="font-medium text-gray-700 mb-2">Preview</h3>
                <video id="preview" controls class="w-full rounded-lg"></video>
                <canvas id="canvas"></canvas>
            </div>

            <div class="progress-container rounded-full mb-4" id="progressContainer">
                <div class="progress-bar rounded-full" id="progressBar" style="width: 0%"></div>
            </div>

            <div class="flex justify-between">
                <span id="progressText" class="text-sm text-gray-500">Waiting to convert...</span>
                <span id="sizeText" class="text-sm text-gray-500">Output will be â‰¤2.5MB</span>
            </div>

            <button 
                id="convertBtn" 
                class="mt-6 w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition-colors"
                disabled
            >
                Convert to GIF
            </button>
        </div>

        <div id="result" class="bg-white rounded-xl shadow-lg p-6 hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Your GIF is Ready!</h2>
            <img id="gifResult" src="" alt="Generated GIF preview" class="w-full mb-4 rounded-lg border" src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/0b730d2a-33cf-4290-8c0f-6c75b530d02c.png">
            <div class="flex flex-col sm:flex-row gap-3">
                <button 
                    id="downloadBtn" 
                    class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors"
                >
                    Download GIF
                </button>
                <button 
                    id="resetBtn" 
                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg transition-colors"
                >
                    Convert Another
                </button>
            </div>
            <p id="fileSizeInfo" class="text-sm text-gray-500 mt-3 text-center"></p>
        </div>
    </div>

    <script>
        // Global variables
        let videoFile = null;
        let videoElement = document.getElementById('preview');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let gifUrl = null;
        let ffmpeg = null;

        // Initialize FFmpeg.js
        async function initFFmpeg() {
            ffmpeg = new FFmpeg();
            ffmpeg.on('log', ({ message }) => console.log(message));
            ffmpeg.on('progress', ({ progress }) => {
                document.getElementById('progressBar').style.width = `${progress * 100}%`;
                document.getElementById('progressText').textContent = `Processing ${Math.round(progress * 100)}%`;
            });
            await ffmpeg.load();
        }

        // Handle file selection
        document.getElementById('fileInput').addEventListener('change', async function(e) {
            handleFile(e.target.files[0]);
        });

        // Handle drop
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            handleFile(file);
        }

        // Process selected file
        async function handleFile(file) {
            if (!file.type.startsWith('video/')) {
                alert('Please select a video file.');
                return;
            }

            // Check file size (optional)
            if (file.size > 100 * 1024 * 1024) { // 100MB limit
                alert('Video file is too large. Please select a smaller file (max 100MB).');
                return;
            }

            videoFile = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('videoInfo').classList.remove('hidden');
            document.getElementById('controls').classList.remove('hidden');

            // Initialize FFmpeg if not already done
            if (!ffmpeg) {
                await initFFmpeg();
            }

            // Set up video preview
            const url = URL.createObjectURL(file);
            videoElement.src = url;
            videoElement.load();

            // Enable convert button when meta data is loaded
            videoElement.onloadedmetadata = function() {
                document.getElementById('duration').max = Math.floor(videoElement.duration);
                document.getElementById('convertBtn').disabled = false;
            };
        }

        // Convert video to GIF with size constraint
        document.getElementById('convertBtn').addEventListener('click', async function() {
            if (!videoFile) return;

            const startTime = parseFloat(document.getElementById('startTime').value);
            const duration = parseFloat(document.getElementById('duration').value);
            const fps = parseInt(document.getElementById('fps').value);
            const quality = document.getElementById('quality').value;

            if (startTime < 0 || duration <= 0) {
                alert('Please enter valid time values.');
                return;
            }

            const btn = this;
            btn.disabled = true;
            btn.textContent = 'Processing...';

            try {
                document.getElementById('progressContainer').classList.remove('hidden');
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('progressText').textContent = 'Starting conversion...';

                // Write the video file to FFmpeg
                await ffmpeg.writeFile('input.mp4', await fetchFile(videoFile));

                // Calculate target output size (2.5MB)
                const targetBytes = 2.5 * 1024 * 1024;
                const estimatedBytesPerFrame = targetBytes / (fps * duration);
                
                // Choose quality parameters based on selection
                let scale = "640:-1";
                let paletteQuality = "stats_mode=diff";
                let dither = "bayer:bayer_scale=3";
                
                if (quality === 'low') {
                    scale = "320:-1";
                    paletteQuality = "stats_mode=single";
                    dither = "bayer:bayer_scale=5";
                } else if (quality === 'high') {
                    scale = "800:-1";
                    paletteQuality = "stats_mode=full";
                    dither = "bayer:bayer_scale=2";
                }

                // Execute FFmpeg commands
                await ffmpeg.exec([
                    '-i', 'input.mp4',
                    '-ss', startTime.toString(),
                    '-t', duration.toString(),
                    '-vf', `fps=${fps},scale=${scale}:flags=lanczos`,
                    '-gifflags', '+transdiff',
                    '-f', 'gif',
                    'output.gif'
                ]);

                // Read the result
                const data = await ffmpeg.readFile('output.gif');
                const blob = new Blob([data], { type: 'image/gif' });
                
                // Check if the size exceeds 2.5MB and apply additional compression if needed
                if (blob.size > targetBytes) {
                    document.getElementById('progressText').textContent = 'Optimizing size...';
                    
                    // Apply palette optimization
                    await ffmpeg.exec([
                        '-i', 'output.gif',
                        '-filter_complex', `palettegen=max_colors=256:reserve_transparent=0[palette];[0:v][palette]paletteuse=dither=${dither}`,
                        '-f', 'gif',
                        'optimized.gif'
                    ]);
                    
                    const optimizedData = await ffmpeg.readFile('optimized.gif');
                    gifUrl = URL.createObjectURL(new Blob([optimizedData], { type: 'image/gif' }));
                } else {
                    gifUrl = URL.createObjectURL(blob);
                }

                // Display result
                document.getElementById('gifResult').src = gifUrl;
                document.getElementById('result').classList.remove('hidden');
                document.getElementById('controls').classList.add('hidden');
                
                // Update file size info
                const response = await fetch(gifUrl);
                const gifBlob = await response.blob();
                const sizeMB = (gifBlob.size / (1024 * 1024)).toFixed(2);
                document.getElementById('fileSizeInfo').textContent = `File size: ${sizeMB} MB`;
                
            } catch (error) {
                console.error('Conversion error:', error);
                alert('Error during conversion. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Convert to GIF';
            }
        });

        // Helper function to read file
        function fetchFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(new Uint8Array(reader.result));
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Download GIF
        document.getElementById('downloadBtn').addEventListener('click', function() {
            if (!gifUrl) return;
            
            const a = document.createElement('a');
            a.href = gifUrl;
            a.download = videoFile ? 
                `${videoFile.name.replace(/\.[^/.]+$/, '')}.gif` : 
                'converted.gif';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        // Reset converter
        document.getElementById('resetBtn').addEventListener('click', function() {
            document.getElementById('result').classList.add('hidden');
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('videoInfo').classList.add('hidden');
            
            if (gifUrl) {
                URL.revokeObjectURL(gifUrl);
                gifUrl = null;
            }
            
            if (videoElement.src) {
                URL.revokeObjectURL(videoElement.src);
                videoElement.src = '';
            }
            
            videoFile = null;
            document.getElementById('fileInput').value = '';
        });

        // Display instructions on first load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Video to GIF Converter ready');
        });
    </script>
</body>
</html>

